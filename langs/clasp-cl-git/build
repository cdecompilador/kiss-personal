#!/bin/sh -e

export DESTDIR="$1"

if kiss list musl; then
    patch -p1 < musl-koga-libexecinfo-fix.patch
fi

sbcl --script koga \
    --reproducible-build \
    --package-path="$1" \
    --bin-path=/usr/bin/ \
    --share-path=/usr/share/clasp/ \
    --lib-path=/usr/lib/clasp/

sed -i "s/stdio.h>/stdio.h>\n#include <ucontext.h>/" src/bdwgc/mach_dep.c
sed -i "s/-fuse-ld=gold//" build/build.ninja

ninja -C build
ninja -C build install
