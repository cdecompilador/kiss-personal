#!/bin/sh -e

seen_f=$(mktemp)

get_deps() {
    f="$(kiss search "$1" | sed q)/depends"
    if [ -e "$f" ]; then
        cut -d' ' -f1 < "$f"
    fi
}

m() {
    for d in "$@"; do
        d_d=$(get_deps "$d")
        echo "$d_d" | tr ' ' '\n' | xargs -I{} echo "$d;{}"
        echo "$@" >> "$seen_f"
        for j in $d_d; do
            if grep -q "$j" "$seen_f"; then
                d_d=$(echo $d_d | sed "s/$j//")
            fi
        done
        m $d_d
    done
}

dotgraph() {
    echo "strict digraph \"$1\"{"
    m "$1" | sed -E "s/(.*);(.*)$/\"\1\" -> \"\2\";/"
    echo "  \"$1\""
    echo "}"
    rm -- "$seen_f"
}

dotgraph "$1" |
if command -v tred 1>/dev/null 2>&1; then
    tred
else
    tee
fi
