#!/bin/sh -e

get_deps() {
    f="$(kiss search "$1" | sed q)/depends"
    [ -e "$f" ] && cut -d' ' -f1 < "$f"
}

z() {
    # If the package is not installed, then we need to mark it, and get
    # it's missing depends too. Basically an aux function for aux.
    p="$1"
    echo "$p" # log the package
    shift
    aux $(get_deps "$p" | grep -vE "($(echo "$@" | tr ' ' '|'))")
}

aux() {
    # Parallelizing here saves a good amount of time.
    for d in "$@"; do
        ( z "$d" "$@" ) &
    done
    wait
}

pkg=$1

[ -z "$1" ] && pkg=$(basename "$PWD")

aux $(get_deps "$pkg") | sort -u
